<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mobile Voice Recorder</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: #212121;
            color: #EBE8E8;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
            overflow: hidden;
            position: relative;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            position: relative;
            z-index: 2;
        }
        
        .top-section {
            flex: 0 0 auto;
            padding: 40px 20px 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-height: 150px;
        }
        
        .bullets-container {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            margin-left: 20px;
        }
        
        .bullet-item {
            padding: 8px 0;
            margin-bottom: 16px;
            animation: slideInUp 0.5s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
            transition: all 0.3s ease;
            text-align: left;
            color: #EBE8E8;
            font-size: 1.1rem;
            font-weight: 300;
        }
        
        .bullet-item.fade-out {
            opacity: 0;
            transform: translateY(-20px);
            max-height: 0;
            margin-bottom: 0;
            padding: 0 16px;
        }
        
        .bullet-item:nth-child(odd) {
            animation-delay: 0.1s;
        }
        
        .bullet-item:nth-child(even) {
            animation-delay: 0.2s;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .center-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            position: relative;
            padding: 20px 20px;
            min-height: 200px;
        }
        
        .text-content {
            margin-left: 20px;
            width: calc(100% - 40px);
        }
        
        
        .bottom-section {
            flex: 0 0 auto;
            padding: 20px 20px 140px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            min-height: 100px;
            position: relative;
            z-index: 10;
        }
        
        /* Transcript Screen Styles */
        .transcript-screen {
            display: none;
            flex-direction: column;
            height: 100vh;
            background: #212121;
            color: #EBE8E8;
        }
        
        .transcript-screen.active {
            display: flex;
        }
        
        .transcript-header {
            text-align: center;
            padding: 40px 20px 20px;
            font-size: 2rem;
            font-weight: bold;
            color: #EBE8E8;
        }
        
        .transcript-content {
            flex: 1;
            padding: 0 20px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .transcript-controls {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-button {
            background: transparent;
            border: 1px solid #EBE8E8;
            color: #EBE8E8;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .edit-button:hover {
            background: rgba(235, 232, 232, 0.1);
        }
        
        .transcript-icons {
            display: flex;
            gap: 20px;
        }
        
        .transcript-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #EBE8E8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .transcript-icon:hover {
            background: rgba(235, 232, 232, 0.8);
        }
        
        .transcript-icon svg {
            width: 20px;
            height: 20px;
            fill: #212121;
        }
        
        .question-prompt {
            font-size: 1.56rem;
            font-weight: 400;
            font-style: italic;
            color: #EBE8E8;
            margin: 0;
            text-align: left;
            opacity: 1;
        }
        
        .status {
            display: none;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .control-btn.recording {
            background: rgba(230, 0, 0, 0.3);
            border-color: #e60000;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        
        .timer {
            font-size: 1.25rem;
            font-weight: 300;
            margin: 0 0 8px 0;
            font-variant-numeric: tabular-nums;
            color: #EBE8E8;
            opacity: 0.6;
            text-align: left;
        }
        
        .controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
        }
        
        .btn {
            padding: 15px 30px;
            background: #333;
            border: 1px solid #555;
            color: #f0f0f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: #444;
            border-color: #666;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .transcript {
            background: #2b2b2b;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.6;
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Mobile optimizations */
        @media (max-width: 480px) {
            .record-button {
                width: 100px;
                height: 100px;
            }
            
            .record-icon {
                width: 40px;
                height: 40px;
            }
            
            .record-button.recording .record-icon {
                width: 25px;
                height: 25px;
            }
            
            .timer {
                font-size: 1.8rem;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn {
                width: 100%;
                padding: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-section">
            <div class="bullets-container" id="bulletsContainer">
                <!-- Bullet points will appear here as user speaks -->
            </div>
        </div>
        
        <div class="center-section">
            <div class="text-content">
                <div class="timer" id="timer">00:00</div>
                <div class="question-prompt" id="questionPrompt">How are you feeling today?</div>
            </div>
        </div>
        
        <div class="bottom-section">
            <button class="control-btn" id="playButton" disabled>▶</button>
            <button class="control-btn" id="recordButton">●</button>
            <button class="control-btn" id="stopButton" disabled>⏹</button>
        </div>
        
        <div class="transcript hidden" id="transcript"></div>
    </div>
    
    <!-- Transcript Screen -->
    <div class="transcript-screen" id="transcriptScreen">
        <div class="transcript-header">TRANSCRIPT</div>
        <div class="transcript-content" id="transcriptContent">
            <!-- Transcript content will be populated here -->
        </div>
        <div class="transcript-controls">
            <button class="edit-button" id="editButton">EDIT</button>
            <div class="transcript-icons">
                <div class="transcript-icon" id="transcriptRecord">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"/>
                    </svg>
                </div>
                <div class="transcript-icon" id="transcriptPlay">
                    <svg viewBox="0 0 24 24">
                        <polygon points="5,3 19,12 5,21"/>
                    </svg>
                </div>
                <div class="transcript-icon" id="transcriptStop">
                    <svg viewBox="0 0 24 24">
                        <rect x="6" y="6" width="12" height="12"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MobileVoiceRecorder {
            constructor() {
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.startTime = null;
                this.timerInterval = null;
                this.audioBlob = null;
                
                // Simple recording properties
                
                this.recordButton = document.getElementById('recordButton');
                this.stopButton = document.getElementById('stopButton');
                this.playButton = document.getElementById('playButton');
                this.timer = document.getElementById('timer');
                this.transcript = document.getElementById('transcript');
                this.bulletsContainer = document.getElementById('bulletsContainer');
                this.transcriptScreen = document.getElementById('transcriptScreen');
                this.transcriptContent = document.getElementById('transcriptContent');
                this.editButton = document.getElementById('editButton');
                
                // Bullet point generation
                this.bulletPoints = [];
                this.bulletInterval = null;
                this.maxBullets = 3;
                
                this.setupEventListeners();
                this.checkBrowserSupport();
                this.addInitialBullets();
            }
            
            checkBrowserSupport() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    this.showError('Your browser does not support audio recording. Please use Chrome, Firefox, or Safari.');
                    return false;
                }
                return true;
            }
            
            setupEventListeners() {
                this.recordButton.addEventListener('click', () => this.toggleRecording());
                this.stopButton.addEventListener('click', () => this.stopRecording());
                this.playButton.addEventListener('click', () => this.playRecording());
                this.editButton.addEventListener('click', () => this.editTranscript());
            }
            
            async toggleRecording() {
                if (!this.isRecording) {
                    await this.startRecording();
                } else {
                    this.stopRecording();
                }
            }
            
            async startRecording() {
                try {
                    // Mobile-optimized audio constraints
                    const constraints = {
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 16000,
                            channelCount: 1
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Use webm for better mobile compatibility
                    const options = {
                        mimeType: 'audio/webm;codecs=opus'
                    };
                    
                    // Fallback for iOS Safari
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = 'audio/mp4';
                    }
                    
                    this.mediaRecorder = new MediaRecorder(stream, options);
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        this.audioBlob = new Blob(this.audioChunks, { type: options.mimeType });
                        this.processRecording();
                    };
                    
                    this.mediaRecorder.start(100); // Collect data every 100ms
                    
                    this.isRecording = true;
                    this.recordButton.classList.add('recording');
                    this.recordButton.textContent = '⏸';
                    this.stopButton.disabled = false;
                    this.startTimer();
                    this.startBulletGeneration();
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    
                    if (error.name === 'NotAllowedError') {
                        this.showError('Microphone access denied. Please allow microphone access and refresh the page.');
                    } else if (error.name === 'NotFoundError') {
                        this.showError('No microphone found. Please connect a microphone and try again.');
                    } else {
                        this.showError('Could not start recording. Please try again.');
                    }
                }
            }
            
            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    
                    this.isRecording = false;
                    this.recordButton.classList.remove('recording');
                    this.recordButton.textContent = '●';
                    this.stopButton.disabled = true;
                    this.stopTimer();
                    this.stopBulletGeneration();
                    
                    // Show transcript screen after processing
                    setTimeout(() => {
                        this.showTranscriptScreen();
                    }, 1000);
                }
            }
            
            startTimer() {
                this.startTime = Date.now();
                this.timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    this.timer.textContent = this.formatTime(elapsed);
                }, 100);
            }
            
            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }
            
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            async processRecording() {
                try {
                    // Here you would send to your n8n webhook
                    const formData = new FormData();
                    formData.append('data', this.audioBlob, 'recording.webm');
                    formData.append('timestamp', new Date().toISOString());
                    formData.append('device_type', this.getDeviceType());
                    
                    // Replace with your actual n8n webhook URL
                    const webhookUrl = 'https://staydrmn.app.n8n.cloud/webhook/voice-intake';
                    
                    
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    this.displayTranscript(result.transcript || 'Transcription completed successfully');
                    this.playButton.classList.remove('hidden');
                    
                    // Reset timer
                    this.timer.textContent = '00:00';
                    
                } catch (error) {
                    console.error('Error processing recording:', error);
                    this.showError('Failed to process recording. Please try again.');
                }
            }
            
            playRecording() {
                if (this.audioBlob) {
                    const audioUrl = URL.createObjectURL(this.audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    
                    // Clean up URL after playing
                    audio.addEventListener('ended', () => {
                        URL.revokeObjectURL(audioUrl);
                    });
                }
            }
            
            displayTranscript(text) {
                this.transcript.textContent = text;
                this.transcript.classList.remove('hidden');
            }
            
            showError(message) {
                console.error(message);
                alert(message);
            }
            
            startBulletGeneration() {
                // Sample bullet points that appear during recording
                const sampleBullets = [
                    "Good day so far",
                    "Looking forward to new challenges", 
                    "Feeling optimistic about the future",
                    "Had a productive morning",
                    "Excited about upcoming projects",
                    "Feeling grateful for today",
                    "Ready to tackle new opportunities",
                    "Feeling confident and motivated"
                ];
                
                let bulletIndex = 0;
                this.bulletInterval = setInterval(() => {
                    if (bulletIndex < sampleBullets.length) {
                        this.addBulletPoint(sampleBullets[bulletIndex]);
                        bulletIndex++;
                    }
                }, 3000); // Add a bullet point every 3 seconds
            }
            
            stopBulletGeneration() {
                if (this.bulletInterval) {
                    clearInterval(this.bulletInterval);
                    this.bulletInterval = null;
                }
            }
            
            addInitialBullets() {
                // Add some initial bullet points to show the interface
                const initialBullets = [
                    "Good day so far",
                    "Looking forward to new challenges",
                    "Feeling optimistic about the future"
                ];
                
                initialBullets.forEach((bullet, index) => {
                    setTimeout(() => {
                        this.addBulletPoint(bullet);
                    }, index * 500);
                });
            }
            
            addBulletPoint(text) {
                // Remove oldest bullet if we have 3 or more
                if (this.bulletsContainer.children.length >= this.maxBullets) {
                    const oldestBullet = this.bulletsContainer.firstChild;
                    if (oldestBullet) {
                        oldestBullet.classList.add('fade-out');
                        setTimeout(() => {
                            if (oldestBullet.parentNode) {
                                oldestBullet.parentNode.removeChild(oldestBullet);
                            }
                        }, 300);
                    }
                }
                
                const bulletElement = document.createElement('div');
                bulletElement.className = 'bullet-item';
                bulletElement.textContent = text;
                this.bulletsContainer.appendChild(bulletElement);
                
                // Scroll to bottom to show new bullet
                this.bulletsContainer.scrollTop = this.bulletsContainer.scrollHeight;
            }
            
            showTranscriptScreen() {
                // Hide main container and show transcript screen
                document.querySelector('.container').style.display = 'none';
                this.transcriptScreen.classList.add('active');
                
                // Populate transcript content
                this.transcriptContent.innerHTML = `
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                    <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                `;
            }
            
            editTranscript() {
                // Make transcript content editable
                this.transcriptContent.contentEditable = true;
                this.transcriptContent.focus();
                
                // Change edit button text
                this.editButton.textContent = 'SAVE';
                this.editButton.onclick = () => this.saveTranscript();
            }
            
            saveTranscript() {
                // Save transcript and make it non-editable
                this.transcriptContent.contentEditable = false;
                this.editButton.textContent = 'EDIT';
                this.editButton.onclick = () => this.editTranscript();
            }
            
            getDeviceType() {
                const userAgent = navigator.userAgent;
                if (/iPhone|iPad|iPod/.test(userAgent)) return 'iOS';
                if (/Android/.test(userAgent)) return 'Android';
                if (/Mobi/.test(userAgent)) return 'Mobile';
                return 'Desktop';
            }
        }
        
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MobileVoiceRecorder();
        });
        
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
